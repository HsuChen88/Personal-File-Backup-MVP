AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: 'Dropbex MVP - Full Stack Architecture S3 Storage + Cognito Auth + Python
  Lambda (Groq AI) + Node.js Lambda (Download)

  '
Globals:
  Function:
    Timeout: 10
    MemorySize: 128
  Api:
    Cors:
      AllowMethods: '''GET,POST,OPTIONS'''
      AllowHeaders: '''Content-Type,X-Amz-Date,Authorization,X-Api-Key,X-Amz-Security-Token'''
      AllowOrigin: '''*'''
Parameters:
  AppName:
    Type: String
    Default: dropbex-app-2025
    Description: "\u61C9\u7528\u7A0B\u5F0F\u540D\u7A31"
  GroqApiKey:
    Type: String
    NoEcho: true
    Description: "\u8ACB\u8F38\u5165\u60A8\u7684 Groq API Key (\u7528\u65BC llama-3.1-8b-instant)"
Resources:
  StorageBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName:
        Fn::Sub: ${AppName}-storage-${AWS::AccountId}
      CorsConfiguration:
        CorsRules:
        - AllowedHeaders:
          - '*'
          AllowedMethods:
          - GET
          - PUT
          - POST
          - DELETE
          - HEAD
          AllowedOrigins:
          - '*'
          ExposedHeaders:
          - ETag
          - x-amz-meta-custom-header
          MaxAge: 3000
  SummaryFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: SummaryFunction
      Handler: summary_handler.lambda_handler
      Runtime: python3.11
      Timeout: 60
      MemorySize: 256
      Environment:
        Variables:
          GROQ_API_KEY:
            Ref: GroqApiKey
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${AppName}-storage-${AWS::AccountId}
      - S3WritePolicy:
          BucketName:
            Fn::Sub: ${AppName}-storage-${AWS::AccountId}
      Events:
        FileUploadEvent:
          Type: S3
          Properties:
            Bucket:
              Ref: StorageBucket
            Events: s3:ObjectCreated:*
            Filter:
              S3Key:
                Rules:
                - Name: prefix
                  Value: uploads/
    Metadata:
      SamResourceId: SummaryFunction
  UserPool:
    Type: AWS::Cognito::UserPool
    Properties:
      UserPoolName:
        Fn::Sub: ${AppName}-user-pool
      AutoVerifiedAttributes:
      - email
      UsernameAttributes:
      - email
  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName:
        Fn::Sub: ${AppName}-client
      UserPoolId:
        Ref: UserPool
      GenerateSecret: false
      ExplicitAuthFlows:
      - ALLOW_USER_SRP_AUTH
      - ALLOW_REFRESH_TOKEN_AUTH
  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName:
        Fn::Sub: ${AppName}IdentityPool
      AllowUnauthenticatedIdentities: false
      CognitoIdentityProviders:
      - ClientId:
          Ref: UserPoolClient
        ProviderName:
          Fn::GetAtt:
          - UserPool
          - ProviderName
  CognitoAuthRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
        - Effect: Allow
          Principal:
            Federated: cognito-identity.amazonaws.com
          Action: sts:AssumeRoleWithWebIdentity
          Condition:
            StringEquals:
              cognito-identity.amazonaws.com:aud:
                Ref: IdentityPool
      Policies:
      - PolicyName: DropbexS3FullAccess
        PolicyDocument:
          Version: '2012-10-17'
          Statement:
          - Effect: Allow
            Action:
            - s3:PutObject
            - s3:GetObject
            - s3:ListBucket
            - s3:DeleteObject
            Resource:
            - Fn::Sub: arn:aws:s3:::${StorageBucket}
            - Fn::Sub: arn:aws:s3:::${StorageBucket}/*
  IdentityPoolRoleAttachment:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId:
        Ref: IdentityPool
      Roles:
        authenticated:
          Fn::GetAtt:
          - CognitoAuthRole
          - Arn
  DownloadFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: DownloadFunction
      Handler: index.handler
      Runtime: nodejs18.x
      Timeout: 10
      Environment:
        Variables:
          BUCKET_NAME:
            Ref: StorageBucket
      Policies:
      - S3ReadPolicy:
          BucketName:
            Fn::Sub: ${AppName}-storage-${AWS::AccountId}
      Events:
        DownloadApi:
          Type: Api
          Properties:
            Path: /download
            Method: get
    Metadata:
      SamResourceId: DownloadFunction
Outputs:
  Region:
    Value:
      Ref: AWS::Region
  S3BucketName:
    Value:
      Ref: StorageBucket
  UserPoolId:
    Value:
      Ref: UserPool
  UserPoolClientId:
    Value:
      Ref: UserPoolClient
  IdentityPoolId:
    Value:
      Ref: IdentityPool
  ApiBaseUrl:
    Description: API Gateway Base URL
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod
  DownloadApiUrl:
    Description: Download Endpoint URL (Copy this to config.js)
    Value:
      Fn::Sub: https://${ServerlessRestApi}.execute-api.${AWS::Region}.amazonaws.com/Prod/download
